<!DOCTYPE html>

<html>

	<head>
		<meta charset="utf-8"/>
		<title>Solar system</title>
		<link rel="stylesheet" type="text/css" href="css_script.css">

		<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
	</head>
	<div id="inlinediv">
			<body> 

		<div class="btnHolder">
			<input onclick="newMode()" type="button" value="Adjust size" id="button"></input>
		</div>
		<br/>

		<svg class="svgClass" width="3000" height="2500">
      	<defs id="mdef">
        	<pattern id="image" x="0" y="0" height="200" width="200">
       			<image x="0" y="0" width="200" height="200" xlink:href="sun_edited.png"></image>
        	</pattern>
        </defs>
		</div>
		<script type="text/javascript">
			var stopTimer = 0;
			var width = 3000;
			var height = 2500;

			var data;
			var _data;
			var _Ddata;
			var _Sdata;

			var sunR = 100;
			var sunRconst = 50;
			var sunRcalculated;

			var t0 = Date.now();

			var container;

			var sunData = [{"key":"sun", "radius": 696342}];
	 
			//Append SVG
			var svg = d3.select("body")
			 .append("svg")
			 .attr("class", "svgClass")
			 .attr("width", width)
			 .attr("height", height)
			 .style("background-color","black");
			 //Container for zoom

			 var container = svg.append("g")
		    .attr("transform", "translate(" + width/2 + "," + height/2 + ")");

			 //Create stars
			for(var i = 0; i < (width / 10); i++) {
			    createUniverse();
			}

			//GET DATA FROM JSON
			d3.json("planets.json", function(error, json){
					if (error) return console.warn(error);
              		data = json;
              		_data = data;
              		setDistance();
              		setSize();
				}
			)

			function setSize()
			{
				_Sdata = _data;
				var sunRcalculated = sunData[0].radius;
				var distanceOff;

			    while(sunRcalculated > 5000)
			    {
			    	sunRcalculated = sunRcalculated/2;
			    	for(var i = 0; i < _Sdata.length; i++)
			    	{
			    		_Sdata[i].radius= _Sdata[i].radius / 2;
			    	}
			    }

			    distanceOff = [sunRcalculated+50, sunRcalculated+90, sunRcalculated+150, sunRcalculated+200, sunRcalculated+250, sunRcalculated+350, sunRcalculated+450];

			    for(var i = 0; i < 7; i++)
			    	{
			    		_Sdata[i].distance_from_the_sun = distanceOff[i];
			    		console.log("_Sdata.radius["+i+"]: "+_Sdata[i].radius);
			    		console.log("_Sdata.distance_from_the_sun["+i+"]: "+_Sdata[i].distance_from_the_sun);
			    	}
			}//End of Size scale

			function setDistance()
			{
				_Ddata = _data;
				var sizeOff;

				while(_Ddata[7].distance_from_the_sun > 2000)
				{
					for (var i = 0; i < _data.length; i++) {
						_Ddata[i].distance_from_the_sun = _Ddata[i].distance_from_the_sun/2;
					}
				}

				for(var i = 0; i < _data.length; i++)
			    	{
			    		_Ddata[i].distance_from_the_sun+= (100/2)+50;
			    	}

				sizeOff = [8, 8, 8, 8, 30, 25, 20, 20];

				for(var i = 0; i < _Ddata.length; i++)
			    	{
			    		_Ddata[i].radius = sizeOff[i];
			    		console.log("radius od _Ddata["+i+"]: "+_Ddata[i].radius);
			    	}
			    	_data = _Ddata;
			    	createPlanets();

			}//End of Distance scale

			function createUniverse() {
			    createDot(Math.floor(Math.random()*width), Math.floor(Math.random()*height));

			    function createDot(x, y) {
			    var elem=document.createElement("div");
			    elem.setAttribute("class", "dot");
			    elem.setAttribute("style", "left:"+x+"px;top:"+y+"px;");
			    document.getElementsByTagName("body")[0].appendChild(elem);
			    return elem;
				}
			}

			function createPlanets()
			{	
				stopTimer = 0;

				console.log("_data u createPlanets (radius):"+ _data[7].radius);
				
				//CREATE SUN
				svg
				.append("circle")
			  	.attr("r", sunR)
			  	.attr("class", "sun")
			  	.attr("cx", width/2)
			    .attr("cy", height/2)
			    .style("fill", "url(#image)");
				console.log("Stvorim Sunce");

			    //CREATE ORBITALS
				container.selectAll("g.orbital")
				.data(_data)
				.enter()
				.append("g")
				.attr("class", "orbital")
				.each(function(d, i) {
				    d3.select(this)
					.append("circle")
					.attr("class", "orbit")
					.attr("r", function(d){
					    return d.distance_from_the_sun; })
					.style("fill","none")
					.style("stroke","white");
					}
				);	//Append all orbitals
				console.log("Stvorim orbitale");

		    	container.selectAll("g.planet")
		    	.data(_data)
		    	.enter()
		    	.append("g")
		    	.attr("class", "planet")
		    	.each(function(d, i) {
				    d3.select(this)
				    .append("circle")
					.attr("class", "planet")
					.attr("r", function(d){
					    return d.radius })
					.attr("cx", function() {
					    return d.distance_from_the_sun; })
					.attr("cy", 0)
					.style("fill", "blue")
				});
		    	//ROTATION COUNTER
		    	d3.timer(function() 
		    	{
				    var delta = (Date.now() - t0);
				    svg.selectAll(".planet")
				    .attr("transform", function(d,t) 
				    {
						var rotateP = (90 + delta * (1/d.orbital_period)/20);
						if(stopTimer == 1)
						{
							return true;
						}
				    	return "rotate("+ d.orbit_side + (rotateP) + ")";
				    }
				    );
				}
			  	);//END OF TIMER
		    
			}//END OF FUNCTION

			//CHANGE MODE
			function newMode(){
				if (this.value=="Adjust size") {
					this.value = "Adjust distance";
					_data = _Sdata;
					sunR = sunRcalculated;
					createPlanets();
				}
    			else {
    				this.value = "Adjust size";
    				_data = _Ddata;
					sunR = 50;
					createPlanets();
    			}

    			stopTimer = 1;
				d3.select("svg").select(".sun").remove();
				d3.select("svg").selectAll("g.planet").remove();
				d3.select("svg").selectAll("g.orbital").remove();
			}

		</script>
	</body>
</html>